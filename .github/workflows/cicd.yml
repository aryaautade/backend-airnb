name: Docker CI Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted

    steps:
    # 1️⃣ Checkout Repository
    - uses: actions/checkout@v4

    # 2️⃣ Backup .env (if exists)
    - name: Backup .env
      shell: powershell
      run: |
        if (!(Test-Path -Path .\temp)) { New-Item -ItemType Directory -Path .\temp }
        if (Test-Path .\.env) { Move-Item .\.env .\temp\env_backup -Force }

    # 3️⃣ Restore .env (if exists)
    - name: Restore .env
      shell: powershell
      run: |
        if (Test-Path .\temp\env_backup) { Move-Item .\temp\env_backup .\.env -Force }

    # 4️⃣ Build Docker Image
    - name: Build Docker Image
      run: docker build -t backend-airnb .

    # 5️⃣ Stop Old Container (if running)
    - name: Stop old container
      shell: powershell
      run: |
        docker stop backend-airnb 2>$null

    # 6️⃣ Remove Old Container (if exists)
    - name: Remove old container
      shell: powershell
      run: |
        docker rm backend-airnb 2>$null

    # 7️⃣ Run New Container
    - name: Run new container
      run: docker run -d -p 3000:3000 --name backend-airnb backend-airnb
