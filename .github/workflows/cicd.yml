name: Node.js CI

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    # 1️⃣ Checkout repo
    - uses: actions/checkout@v4

    # 2️⃣ Backup .env
    - name: Backup .env
      shell: powershell
      run: |
        if (!(Test-Path -Path .\temp)) { New-Item -ItemType Directory -Path .\temp }
        if (Test-Path .\.env) { Move-Item .\.env .\temp\env_backup }

    # 3️⃣ Restore .env
    - name: Restore .env
      shell: powershell
      run: |
        if (Test-Path .\temp\env_backup) { Move-Item .\temp\env_backup .\.env }

    # 4️⃣ Setup Node.js
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    # 5️⃣ Install dependencies
    - run: npm ci
      shell: powershell

    # 6️⃣ Build project
    - run: npm run build --if-present
      shell: powershell

    # 7️⃣ Restart backend via PM2
    - name: Restart backend via PM2
      shell: powershell
      run: |
        try {
            pm2 restart backend
        } catch {
            npm install -g pm2
            pm2 start backend
        }
